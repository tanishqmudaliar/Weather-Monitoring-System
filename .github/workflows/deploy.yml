name: Deploy to PythonAnywhere

# Trigger: This workflow runs automatically when code is pushed to the master branch
on:
  push:
    branches: [ master ]

jobs:
  deploy:
    # Uses Ubuntu as the virtual machine to run these commands
    runs-on: ubuntu-latest
    
    # Links this deployment to GitHub's "Production" environment
    # This creates deployment records visible in your repo's deployments tab
    environment: 
      name: Production
      url: https://tanishqmudaliar.pythonanywhere.com/

    steps:
      # Step 1: Downloads your repository code into the GitHub Actions runner
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Main deployment logic
      - name: Deploy to PythonAnywhere
        env:
          # These secrets must be added to your GitHub repo settings
          PYTHONANYWHERE_USERNAME: ${{ secrets.PYTHONANYWHERE_USERNAME }}
          PYTHONANYWHERE_API_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          echo "üöÄ Starting deployment process..."
          echo "üë§ Username: ${PYTHONANYWHERE_USERNAME}"
          
          # Check if secrets are set
          if [ -z "$PYTHONANYWHERE_USERNAME" ]; then
            echo "‚ùå ERROR: PYTHONANYWHERE_USERNAME secret is not set!"
            echo "Please add it in: Repository Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          if [ -z "$PYTHONANYWHERE_API_TOKEN" ]; then
            echo "‚ùå ERROR: PYTHONANYWHERE_API_TOKEN secret is not set!"
            echo "Please add it in: Repository Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          fi
          
          # Create a bash console on PythonAnywhere to execute commands
          echo "üì° Creating console session on PythonAnywhere..."
          
          CONSOLE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{
              \"executable\": \"bash\",
              \"arguments\": [],
              \"working_directory\": \"/home/${PYTHONANYWHERE_USERNAME}\"
            }")
          
          # Extract HTTP status code
          HTTP_CODE=$(echo "$CONSOLE_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d':' -f2)
          RESPONSE_BODY=$(echo "$CONSOLE_RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
          
          echo "üìä API Response Code: $HTTP_CODE"
          echo "üìÑ Response Body: $RESPONSE_BODY"
          
          # Check if API call was successful
          if [ "$HTTP_CODE" != "201" ] && [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Failed to create console. HTTP Code: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            echo ""
            echo "üîç Possible issues:"
            echo "  1. Invalid API token - Get new token from: https://www.pythonanywhere.com/account/#api_token"
            echo "  2. Incorrect username in secrets"
            echo "  3. API rate limit exceeded"
            echo "  4. PythonAnywhere API is down"
            exit 1
          fi
          
          # Extract the console ID from the API response
          # Using multiple methods to ensure we get the ID
          CONSOLE_ID=$(echo "$RESPONSE_BODY" | grep -oP '"id":\s*\K[0-9]+' || echo "$RESPONSE_BODY" | grep -o '"id":[0-9]*' | cut -d':' -f2)
          
          if [ -z "$CONSOLE_ID" ]; then
            echo "‚ùå Failed to extract console ID from response"
            echo "Full response: $RESPONSE_BODY"
            exit 1
          fi
          
          echo "‚úÖ Console created with ID: $CONSOLE_ID"
          
          # Navigate to your project directory and pull latest code from GitHub
          echo "üì• Pulling latest code from GitHub..."
          curl -s -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/send_input/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"input": "cd Weather-Monitoring-System && git pull origin master\n"}'
          
          # Wait for git pull to complete (adjust time if needed)
          echo "‚è≥ Waiting for git pull to complete..."
          sleep 8
          
          # Install or update Python dependencies
          echo "üì¶ Installing dependencies..."
          curl -s -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/send_input/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"input": "cd Weather-Monitoring-System && pip install -r requirements.txt --user\n"}'
          
          # Wait for pip install to complete
          echo "‚è≥ Waiting for pip install to complete..."
          sleep 12
          
          # Kill the console (cleanup)
          echo "üßπ Cleaning up console..."
          curl -s -X DELETE \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}"
          
          # Reload the web app to apply changes
          echo "üîÑ Reloading web application..."
          RELOAD_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/webapps/${PYTHONANYWHERE_USERNAME}.pythonanywhere.com/reload/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}")
          
          RELOAD_HTTP_CODE=$(echo "$RELOAD_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d':' -f2)
          RELOAD_BODY=$(echo "$RELOAD_RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
          
          echo "üìä Reload Response Code: $RELOAD_HTTP_CODE"
          
          if [ "$RELOAD_HTTP_CODE" = "200" ]; then
            echo "‚úÖ Web app reloaded successfully!"
          else
            echo "‚ö†Ô∏è  Unexpected reload response code: $RELOAD_HTTP_CODE"
            echo "Response: $RELOAD_BODY"
            echo "Note: App may still be running with old code"
          fi
          
          echo "üéâ Deployment completed!"

      # Step 3: Show deployment status (runs regardless of success/failure)
      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Successfully deployed to PythonAnywhere"
            echo "üåê Live at: https://tanishqmudaliar.pythonanywhere.com/"
          else
            echo "‚ùå Deployment failed - check the logs above"
            echo ""
            echo "üîß Troubleshooting steps:"
            echo "  1. Verify secrets are set correctly in GitHub repo settings"
            echo "  2. Check PythonAnywhere API token is valid"
            echo "  3. Ensure Weather-Monitoring-System folder exists on PythonAnywhere"
            echo "  4. Check PythonAnywhere console for manual deployment"
            exit 1
          fi
