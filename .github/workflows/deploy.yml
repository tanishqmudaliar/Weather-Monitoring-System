name: Deploy to PythonAnywhere

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    environment: 
      name: Production
      url: https://tanishqmudaliar.pythonanywhere.com/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to PythonAnywhere
        env:
          PYTHONANYWHERE_USERNAME: ${{ secrets.PYTHONANYWHERE_USERNAME }}
          PYTHONANYWHERE_API_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        run: |
          set -e  # Exit on any error
          
          echo "üöÄ Starting deployment process..."
          echo "üë§ Username: ${PYTHONANYWHERE_USERNAME}"
          
          # Check if secrets are set
          if [ -z "$PYTHONANYWHERE_USERNAME" ] || [ -z "$PYTHONANYWHERE_API_TOKEN" ]; then
            echo "‚ùå ERROR: Secrets not configured properly!"
            exit 1
          fi
          
          echo "üì° Creating console session..."
          
          # Create console - try without arguments field since it's causing issues
          CONSOLE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"executable":"bash","working_directory":"/home/'${PYTHONANYWHERE_USERNAME}'"}')
          
          # Get HTTP code from last line
          HTTP_CODE=$(echo "$CONSOLE_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$CONSOLE_RESPONSE" | head -n-1)
          
          echo "üìä HTTP Code: $HTTP_CODE"
          echo "üìÑ Response: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå Failed to create console"
            exit 1
          fi
          
          # Extract console ID
          CONSOLE_ID=$(echo "$RESPONSE_BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)
          
          if [ -z "$CONSOLE_ID" ]; then
            echo "‚ùå Could not extract console ID"
            exit 1
          fi
          
          echo "‚úÖ Console created: $CONSOLE_ID"
          
          # Pull latest code
          echo "üì• Pulling code from GitHub..."
          curl -s -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/send_input/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"input":"cd Weather-Monitoring-System && git pull origin master\n"}' > /dev/null
          
          sleep 55
          
          # Install dependencies
          echo "üì¶ Installing dependencies..."
          curl -s -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/send_input/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"input":"cd Weather-Monitoring-System && pip install -r requirements.txt --user\n"}' > /dev/null
          
          sleep 55
          
          # Clean up console
          echo "üßπ Cleaning up..."
          curl -s -X DELETE \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" > /dev/null
          
          # Reload webapp
          echo "üîÑ Reloading webapp..."
          RELOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/webapps/${PYTHONANYWHERE_USERNAME}.pythonanywhere.com/reload/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}")
          
          RELOAD_CODE=$(echo "$RELOAD_RESPONSE" | tail -n1)
          
          if [ "$RELOAD_CODE" = "200" ]; then
            echo "‚úÖ Webapp reloaded successfully!"
          else
            echo "‚ö†Ô∏è  Reload returned: $RELOAD_CODE"
          fi
          
          echo ""
          echo "üéâ Deployment complete!"
          echo "üåê https://${PYTHONANYWHERE_USERNAME}.pythonanywhere.com/"

      - name: Notify Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi
