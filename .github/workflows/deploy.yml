name: Deploy to PythonAnywhere

on:
  push:
    branches:  [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    environment:  
      name:  Production
      url: https://tanishqmudaliar.pythonanywhere.com/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name:  Deploy to PythonAnywhere
        env:
          PYTHONANYWHERE_USERNAME: ${{ secrets. PYTHONANYWHERE_USERNAME }}
          PYTHONANYWHERE_API_TOKEN:  ${{ secrets. PYTHONANYWHERE_API_TOKEN }}
        run: |
          set -e
          
          echo "üöÄ Starting deployment process..."
          
          if [ -z "$PYTHONANYWHERE_USERNAME" ] || [ -z "$PYTHONANYWHERE_API_TOKEN" ]; then
            echo "‚ùå ERROR:  Secrets not configured properly!"
            exit 1
          fi
          
          # Use the FILES API to check current state first
          echo "üìÇ Checking current deployment..."
          FILES_CHECK=$(curl -s -w "\n%{http_code}" \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/files/path/home/${PYTHONANYWHERE_USERNAME}/Weather-Monitoring-System/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}")
          
          FILES_CODE=$(echo "$FILES_CHECK" | tail -n1)
          echo "üìä Files API response: $FILES_CODE"
          
          # Create console with a small delay for initialization
          echo "üì° Creating console session..."
          CONSOLE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://www.pythonanywhere. com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" \
            -H "Content-Type:  application/json" \
            -d '{"executable":"bash","working_directory":"/home/'${PYTHONANYWHERE_USERNAME}'"}')
          
          HTTP_CODE=$(echo "$CONSOLE_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$CONSOLE_RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" != "201" ]; then
            echo "‚ùå Failed to create console:  $RESPONSE_BODY"
            exit 1
          fi
          
          CONSOLE_ID=$(echo "$RESPONSE_BODY" | grep -o '"id":[0-9]*' | head -1 | cut -d': ' -f2)
          echo "‚úÖ Console created:  $CONSOLE_ID"
          
          # Wait for console to be ready
          echo "‚è≥ Waiting for console to initialize..."
          sleep 5
          
          # Send all commands in one go with proper error handling and output
          echo "üì• Executing deployment commands..."
          curl -s -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/send_input/" \
            -H "Authorization:  Token ${PYTHONANYWHERE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d '{"input":"cd /home/'${PYTHONANYWHERE_USERNAME}'/Weather-Monitoring-System && echo \"Current commit: $(git rev-parse HEAD)\" && git fetch origin master && git reset --hard origin/master && echo \"New commit: $(git rev-parse HEAD)\" && pip install -r requirements. txt --user && echo \"DEPLOYMENT_COMPLETE\"\n"}'
          
          # Wait and poll for output
          echo "‚è≥ Waiting for commands to complete..."
          sleep 60
          
          # Get console output to verify
          echo "üìÑ Fetching console output..."
          OUTPUT=$(curl -s \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/get_latest_output/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}")
          
          echo "Console output: $OUTPUT"
          
          # Clean up console
          echo "üßπ Cleaning up..."
          curl -s -X DELETE \
            "https://www.pythonanywhere. com/api/v0/user/${PYTHONANYWHERE_USERNAME}/consoles/${CONSOLE_ID}/" \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" > /dev/null
          
          # Reload webapp
          echo "üîÑ Reloading webapp..."
          RELOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/webapps/${PYTHONANYWHERE_USERNAME}.pythonanywhere.com/reload/" \
            -H "Authorization:  Token ${PYTHONANYWHERE_API_TOKEN}")
          
          RELOAD_CODE=$(echo "$RELOAD_RESPONSE" | tail -n1)
          
          if [ "$RELOAD_CODE" = "200" ]; then
            echo "‚úÖ Webapp reloaded successfully!"
          else
            echo "‚ö†Ô∏è  Reload returned: $RELOAD_CODE"
          fi
          
          echo "üéâ Deployment complete!"
          echo "üåê https://${PYTHONANYWHERE_USERNAME}.pythonanywhere.com/"

      - name:  Notify Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed"
            exit 1
          fi
